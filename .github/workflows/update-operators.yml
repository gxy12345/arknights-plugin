name: Update Operators

on:
  schedule:
    # 每天早上8点运行 (UTC时间)
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  update-operators:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.update-script.outputs.has_changes }}
      temp_branch: ${{ steps.update-script.outputs.temp_branch }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # 获取完整的git历史以便分支操作
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Run operator update script
      id: update-script
      run: node scripts/update_operators.js

  create-pr:
    needs: update-operators
    if: needs.update-operators.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Create Pull Request
      id: cpr
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: Update character info from remote source"
        title: "chore: Update Character Info"
        body: |
          Automated update of character information from remote source.

          This PR contains updates to the character database based on the latest data from the remote operators JSON.

          ## Changes
          - Added new characters from remote source
          - Updated character information format
        branch: ${{ needs.update-operators.outputs.temp_branch }}
        base: dev
        delete-branch: true
    
    - name: Print Pull Request URL
      run: echo "Created Pull Request at ${{ steps.cpr.outputs.pull-request-url }}"
